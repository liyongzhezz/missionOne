{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{416:function(s,t,a){\"use strict\";a.r(t);var e=a(2),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":s.$parent.slotKey}},[t(\"div\",{staticClass:\"custom-block tip\"},[t(\"p\",{staticClass:\"title\"}),t(\"p\",[s._v(\"一起由于系统参数设置不合理导致的线上kubernetes集群问题\")])]),t(\"h2\",{attrs:{id:\"问题现象\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#问题现象\"}},[s._v(\"#\")]),s._v(\" 问题现象\")]),s._v(\" \"),t(\"p\",[s._v(\"k8s集群内服务出现健康检查失败情况，同时系统服务（如kubelet也出现异常重启现象）\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"问题分析\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#问题分析\"}},[s._v(\"#\")]),s._v(\" 问题分析\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"初步定位\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#初步定位\"}},[s._v(\"#\")]),s._v(\" 初步定位\")]),s._v(\" \"),t(\"p\",[s._v(\"通过下面的命令检查kubelet的日志：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[s._v(\"journalctl \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"-u\")]),s._v(\" kubelet\\n\")])])]),t(\"p\",[s._v(\"确实发现了一些异常记录，这里摘抄关键的部分：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language- extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[t(\"code\",[s._v(\"kubelet[3124]: runtime: failed to create new OS thread (have 15 already; errno=11)\\nruntime: may need to increase max user processes (ulimiu)\\nkubelet[3124]: fatal error: newosproc\\nkubelet[3124]: goroutine 1 [running, locked to thread]:\\n\")])])]),t(\"p\",[s._v(\"此时分析系统日志，发现无法创建进程：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"dmesg\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"-TL\")]),s._v(\"\\n\\n-bash: fork: retry: No child processes\\n\")])])]),t(\"p\",[s._v(\"再手动启动容器，发现也无法创建，提示初始化线程资源失败：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"docker\")]),s._v(\" run \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"-it\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"--rm\")]),s._v(\" centos \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"bash\")]),s._v(\"\\n\\nruntime/cgo: runtime/cgo: pthread_create failed: Resource temporarily unavailable\\npthread_create failed: Resource temporarily unavailable\\nSIGABRT: abort\\n\")])])]),t(\"p\",[s._v(\"到此怀疑是系统中关于进程相关的参数限制了新的进程创建，导致的问题，于是进一步分析系统参数问题。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"进一步分析\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#进一步分析\"}},[s._v(\"#\")]),s._v(\" 进一步分析\")]),s._v(\" \"),t(\"p\",[s._v(\"检查\"),t(\"code\",[s._v(\"ulimit\")]),s._v(\"设置：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token builtin class-name\"}},[s._v(\"ulimit\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"-a\")]),s._v(\"\\n\\ncore \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"file\")]),s._v(\" size          \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"blocks, -c\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"\\ndata seg size           \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"kbytes, -d\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" unlimited\\nscheduling priority             \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"-e\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"file\")]),s._v(\" size               \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"blocks, -f\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" unlimited\\npending signals                 \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"-i\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"249047\")]),s._v(\"\\nmax locked memory       \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"kbytes, -l\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"64\")]),s._v(\"\\nmax memory size         \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"kbytes, -m\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" unlimited\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"open\")]),s._v(\" files                      \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"-n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"65535\")]),s._v(\"\\npipe size            \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"512\")]),s._v(\" bytes, -p\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"8\")]),s._v(\"\\nPOSIX message queues     \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"bytes, -q\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"819200\")]),s._v(\"\\nreal-time priority              \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"-r\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),s._v(\"\\nstack size              \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"kbytes, -s\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"8192\")]),s._v(\"\\ncpu \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"time\")]),s._v(\"               \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"seconds, -t\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" unlimited\\nmax user processes              \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"-u\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"249047\")]),s._v(\"\\nvirtual memory          \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"kbytes, -v\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" unlimited\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"file\")]),s._v(\" locks                      \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"-x\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" unlimited\\n\")])])]),t(\"p\",[s._v(\"这里设置的是\"),t(\"code\",[s._v(\"249047\")]),s._v(\"，再检查root用户的ulimit设置：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"cat\")]),s._v(\" /etc/security/limits.conf\\n\\nroot soft nofile \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"65535\")]),s._v(\"\\nroot hard nofile \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"65535\")]),s._v(\"\\n* soft nofile \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"65535\")]),s._v(\"\\n* hard nofile \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"65535\")]),s._v(\"\\n\")])])]),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"从监控信息分析，故障时间区间，系统运行的线程略高 \"),t(\"code\",[s._v(\"31616\")]),s._v(\"，但是该值却没有超过当前用户的 \"),t(\"code\",[s._v(\"ulimit -u\")]),s._v(\" 的值，初步排除该线索。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"根据系统抛出的错误提示，搜索到如下的Issues：\"),t(\"a\",{attrs:{href:\"https://github.com/awslabs/amazon-eks-ami/issues/239\",target:\"_blank\",rel:\"noopener noreferrer\"}},[s._v(\"github issues\"),t(\"OutboundLink\")],1),s._v(\"，并看到如下的信息\")])])]),s._v(\" \"),t(\"blockquote\",[t(\"p\",[s._v(\"One possible cause is running out of process IDs. Check you don't  have 40.000 defunct processes or similar on nodes with problems\")])]),s._v(\" \"),t(\"p\",[s._v(\"于是进一步搜索，定位到一个可疑的系统参数：\"),t(\"code\",[s._v(\"kernel.pid_max\")]),s._v(\"，其含义如下：这个参数约束了系统最大创建的进程和线程数量，如果超过这个值则会抛出\"),t(\"code\",[s._v(\"Resource temporarily unavailable，create No more processes\")]),s._v(\"的错误。\")]),s._v(\" \"),t(\"p\",[s._v(\"检查当前系统该参数的值：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-bash extra-class\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"sysctl\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"-a\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"|\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"grep\")]),s._v(\" pid_max\\n\\nkernel.pid_max \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"32768\")]),s._v(\"\\n\")])])]),t(\"h2\",{attrs:{id:\"优化方法\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#优化方法\"}},[s._v(\"#\")]),s._v(\" 优化方法\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"由于kubernetes平台单节点可能需要运行上百个容器，故可以提前根据实际业务调整\"),t(\"code\",[s._v(\"kernel.pid_max\")]),s._v(\"的值；\")])])])}),[],!1,null,null,null);t.default=n.exports}}]);","extractedComments":[]}