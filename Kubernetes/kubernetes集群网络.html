<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kubernetes集群网络 | MissionOne</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="只有一个Mission">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/missionOne/assets/css/0.styles.934ed93a.css" as="style"><link rel="preload" href="/missionOne/assets/js/app.d1f3ab04.js" as="script"><link rel="preload" href="/missionOne/assets/js/3.4a4ab4e6.js" as="script"><link rel="preload" href="/missionOne/assets/js/1.6a874a38.js" as="script"><link rel="preload" href="/missionOne/assets/js/8.4e05e388.js" as="script"><link rel="prefetch" href="/missionOne/assets/js/10.1b3e5823.js"><link rel="prefetch" href="/missionOne/assets/js/11.cda5caec.js"><link rel="prefetch" href="/missionOne/assets/js/12.7496d364.js"><link rel="prefetch" href="/missionOne/assets/js/13.1b4fc967.js"><link rel="prefetch" href="/missionOne/assets/js/14.5cfa31bb.js"><link rel="prefetch" href="/missionOne/assets/js/15.87b75c2d.js"><link rel="prefetch" href="/missionOne/assets/js/16.666cdc7d.js"><link rel="prefetch" href="/missionOne/assets/js/17.1ef2914a.js"><link rel="prefetch" href="/missionOne/assets/js/18.a0a9066e.js"><link rel="prefetch" href="/missionOne/assets/js/19.73fb5ef8.js"><link rel="prefetch" href="/missionOne/assets/js/20.1179fa70.js"><link rel="prefetch" href="/missionOne/assets/js/21.05f27101.js"><link rel="prefetch" href="/missionOne/assets/js/22.f418beee.js"><link rel="prefetch" href="/missionOne/assets/js/4.e8a2ffb5.js"><link rel="prefetch" href="/missionOne/assets/js/5.c6954da7.js"><link rel="prefetch" href="/missionOne/assets/js/6.b855b88f.js"><link rel="prefetch" href="/missionOne/assets/js/7.9389f109.js"><link rel="prefetch" href="/missionOne/assets/js/9.21a8b884.js">
    <link rel="stylesheet" href="/missionOne/assets/css/0.styles.934ed93a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>MissionOne</h3> <p class="description" data-v-59e6cb88>只有一个Mission</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/missionOne/" class="home-link router-link-active"><!----> <span class="site-name">MissionOne</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/missionOne/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/missionOne/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/Docker/" class="nav-link"><i class="undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/Python/" class="nav-link"><i class="undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/Kubernetes常见问题/" class="nav-link"><i class="undefined"></i>
  Kubernetes常见问题
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li></ul></div></div><div class="nav-item"><a href="/missionOne/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      找到我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/liyongzhezz" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/missionOne/avator.jpeg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>7</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/missionOne/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/missionOne/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/Docker/" class="nav-link"><i class="undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/Python/" class="nav-link"><i class="undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/Kubernetes常见问题/" class="nav-link"><i class="undefined"></i>
  Kubernetes常见问题
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/算法/" class="nav-link"><i class="undefined"></i>
  算法
</a></li><li class="dropdown-item"><!----> <a href="/missionOne/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li></ul></div></div><div class="nav-item"><a href="/missionOne/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      找到我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/liyongzhezz" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/missionOne/" class="sidebar-heading clickable router-link-active"><span>欢迎访问</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/missionOne/" aria-current="page" class="sidebar-link">博客简介</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/missionOne/Docker/docker的网络模式" class="sidebar-heading clickable"><span>Docker</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/missionOne/Kubernetes/kubelet垃圾回收机制" class="sidebar-heading clickable open"><span>Kubernetes</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/missionOne/Kubernetes/kubelet垃圾回收机制.html" class="sidebar-link">kubelet垃圾回收机制</a></li><li><a href="/missionOne/Kubernetes/pod优雅关闭重启.html" class="sidebar-link">pod优雅关闭重启</a></li><li><a href="/missionOne/Kubernetes/kubernetes集群网络.html" class="active sidebar-link">kubernetes集群网络</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/missionOne/Kubernetes常见问题/kernel.pid_max引起的问题" class="sidebar-heading clickable"><span>Kubernetes常见问题</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/missionOne/算法/滑动窗口" class="sidebar-heading clickable"><span>算法</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/missionOne/Python/Python3从Kafka消费并处理PB格式数据" class="sidebar-heading clickable"><span>Python</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/missionOne/面试/kubernetes面试题" class="sidebar-heading clickable"><span>面试</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>kubernetes集群网络</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">kubernetes集群网络</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>missionOne</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2022/11/28</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>Kubernetes</span><span class="tag-item" data-v-8a445198>网络</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title"></p><p>Kubernetes本身并没有自己实现容器网络而是通过插件化的方式自由接入，需要满足如下基本原则：</p> <ul><li><p>pod 无论运行在任何节点都可以互相直接通信，而不需要借助 NAT 地址转换实现。</p></li> <li><p>node 与 pod 可以互相通信，在不限制的前提下，pod 可以访问任意网络。</p></li> <li><p>pod 拥有独立的网络栈，pod 看到自己的地址和外部看见的地址应该是一样的，并且同个 pod 内所有的容器共享同个网络栈。</p></li></ul></div><h2 id="容器网络"><a href="#容器网络" class="header-anchor">#</a> 容器网络</h2> <h3 id="容器网络要素"><a href="#容器网络要素" class="header-anchor">#</a> 容器网络要素</h3> <p>一个 Linux 容器的网络栈是被隔离在它自己的 <code>Network Namespace</code>中，<code>Network Namespace</code> 包括了：</p> <ul><li>网卡（Network Interface）；</li> <li>回环设备（Lookback Device）；</li> <li>路由表（Routing Table）；</li> <li>iptables 规则；</li></ul> <h3 id="同宿主机容器通信"><a href="#同宿主机容器通信" class="header-anchor">#</a> 同宿主机容器通信</h3> <p>如果要多台主机通信，我们通过交换机就可以实现彼此互通，在 Linux 中，我们可以通过网桥来转发数据。</p> <p>在容器中，以上的实现是通过 <code>docker0</code> 网桥，凡是连接到 <code>docker0</code> 的容器，就可以通过它来进行通信。要想容器能够连接到 <code>docker0</code> 网桥，我们也需要类似网线的虚拟设备<code>Veth Pair</code> 来把容器连接到网桥上。</p> <blockquote><p>Veth Pair：Veth设备对的引入是为了实现在不同网络命名空间的通信,总是以两张虚拟网卡（veth peer）的形式成对出现的。并且，从其中一端发出的数据，总是能在另外一端收到</p></blockquote> <h3 id="实践"><a href="#实践" class="header-anchor">#</a> 实践</h3> <p>首先启动一个容器：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> c1 alpine:v3.8 /bin/sh
</code></pre></div><p>容器启动后可以看到容器中的网络配置：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> c1  /bin/sh 

<span class="token comment"># ifconfig</span>
eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02
          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:14 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:1172 <span class="token punctuation">(</span><span class="token number">1.1</span> KiB<span class="token punctuation">)</span>  TX bytes:0 <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>  TX bytes:0 <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>

<span class="token comment"># route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
<span class="token number">0.0</span>.0.0         <span class="token number">172.17</span>.0.1      <span class="token number">0.0</span>.0.0         UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> eth0
<span class="token number">172.17</span>.0.0      <span class="token number">0.0</span>.0.0         <span class="token number">255.255</span>.0.0     U     <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> eth0
</code></pre></div><p>可以看到其中有一张 <code>eth0</code> 的网卡，它就是 <code>veth peer</code> 其中的一端的虚拟网卡。然后通过 <code>route -n</code> 查看容器中的路由表，eth0 也正是默认路由出口。所有对172.17.0.0/16 网段的请求都会从 eth0 出去。</p> <p>再在宿主机上查看 <code>Veth peer</code> 的另一端：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ifconfig</span>
docker0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">172.17</span>.0.1  netmask <span class="token number">255.255</span>.0.0  broadcast <span class="token number">172.17</span>.255.255
        inet6 fe80::42:6aff:fe46:93d2  prefixlen <span class="token number">64</span>  scopeid 0x2<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>link<span class="token operator">&gt;</span>
        ether 02:42:6a:46:93:d2  txqueuelen <span class="token number">0</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">8</span>  bytes <span class="token number">656</span> <span class="token punctuation">(</span><span class="token number">656.0</span> B<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>

eth0: <span class="token punctuation">..</span>.

lo: <span class="token punctuation">..</span>.

veth20b3dac: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet6 fe80::30e2:9cff:fe45:329  prefixlen <span class="token number">64</span>  scopeid 0x2<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>link<span class="token operator">&gt;</span>
        ether <span class="token number">32</span>:e2:9c:45:03:29  txqueuelen <span class="token number">0</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">8</span>  bytes <span class="token number">656</span> <span class="token punctuation">(</span><span class="token number">656.0</span> B<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>
</code></pre></div><p>容器对应的 <code>Veth peer</code> 另一端是宿主机上的一块虚拟网卡叫<code>veth20b3dac</code>，并且可以通过 brctl 查看网桥信息看到这张网卡是在 docker0 上。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>brctl show

docker0        <span class="token number">8000</span>.02426a4693d2    no        veth20b3dac
</code></pre></div><p>然后我们再启动一个容器，从第一个容器是能 ping 通第二个容器：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> c2 <span class="token parameter variable">-it</span> alpine:v3.8 /bin/sh

<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> c1 /bin/sh

<span class="token comment"># ping 172.17.0.3</span>
PING <span class="token number">172.17</span>.0.3 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.3<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.291</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.129</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.3: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.142</span> ms
</code></pre></div><p>其原理就是我们 ping 目标 <code>IP 172.17.0.3</code>时，会匹配到我们的路由表第二条规则，网关为0.0.0.0，<strong>这就意味着是一条直连路由，通过二层转发到目的地。</strong> 要通过二层网络到达<code>172.17.0.3</code>，我们需要知道它的 Mac 地址，此时就需要第一个容器发送一个ARP广播，来通过IP地址查找Mac。此时 <code>Veth peer</code> 另外一段是 <code>docker0</code> 网桥，它会广播到所有连接它的 <code>veth peer</code> 虚拟网卡去，然后正确的虚拟网卡收到后会响应这个ARP报文，然后网桥再回给第一个容器。</p> <p><img src="/missionOne/assets/img/docker-bridge.aec5bc07.png" alt="docker bridge"></p> <h2 id="cni-跨主机通信"><a href="#cni-跨主机通信" class="header-anchor">#</a> CNI--跨主机通信</h2> <p>docker默认配置下无法实现跨主机通信，K8s为了更好的控制网络的接入并解决这个问题，推出了 <code>CNI</code> 即<strong>容器网络的 API 接口</strong>。</p> <h3 id="什么是cni"><a href="#什么是cni" class="header-anchor">#</a> 什么是CNI</h3> <p>它是 K8s 中标准的一个调用网络实现的接口，kubelet通过这个API来调用不同的网络插件以实现不同的网络配置，实现了这个接口的就是<code>CNI插件</code>，它实现了一系列的<code>CNI API</code>接口。常见的CNI差劲啊有：flannel、calico、weave、contiv等等。</p> <p>实际上 CNI 的容器网络通信流程跟前面的基础网络一样，只是CNI维护了一个单独的网桥来代替 <code>docker0</code>。这个网桥的名字就叫作：<code>CNI 网桥</code>，它在宿主机上的设备名称默认是：<code>cni0</code>。</p> <p>cni的设计思想，就是：Kubernetes 在启动 <code>Infra</code> 容器之后，就可以直接调用 CNI 网络插件，为这个 <code>Infra</code> 容器的 <code>Network Namespace</code>配置符合预期的网络栈。</p> <h3 id="cni网络模式实现"><a href="#cni网络模式实现" class="header-anchor">#</a> CNI网络模式实现</h3> <p>CNI 插件三种网络实现模式：
<img src="/missionOne/assets/img/cni-type.e3888afe.jpg" alt="cnitype"></p> <ul><li><p>overlay 模式是基于隧道技术实现的，整个容器网络和主机网络独立，容器之间跨主机通信时将整个容器网络封装到底层网络中，然后到达目标机器后再解封装传递到目标容器。不依赖与底层网络的实现。实现的插件有flannel（UDP、vxlan）、calico（IPIP）等等</p></li> <li><p>三层路由模式中容器和主机也属于不同的网段，他们容器互通主要是基于路由表打通，无需在主机之间建立隧道封包。但是限制条件必须依赖大二层同个局域网内。实现的插件有flannel（host-gw）、calico（BGP）等等</p></li> <li><p>underlay网络是底层网络，负责互联互通。容器网络和主机网络依然分属不同的网段，但是彼此处于同一层网络，处于相同的地位。整个网络三层互通，没有大二层的限制，但是需要强依赖底层网络的实现支持.实现的插件有calico（BGP）等等</p></li></ul> <h2 id="flannel插件"><a href="#flannel插件" class="header-anchor">#</a> flannel插件</h2> <h3 id="flannel-host-gw模式"><a href="#flannel-host-gw模式" class="header-anchor">#</a> flannel host-gw模式</h3> <p><code>flannel host-gw</code> 是三层路由模式的一种实现，逻辑如下：</p> <p><img src="/missionOne/assets/img/flannel-host-gw.a8414275.png" alt="flannel host-gw"></p> <ol><li><p><code>node1</code>上<code>container-1</code> 要发数据给 <code>node2</code> 上的 <code>container2</code> 时，会匹配到如下的路由表规则：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">10.244</span>.1.0/24 via <span class="token number">10.168</span>.0.3 dev eth0
</code></pre></div><p>表示前往目标网段 <code>10.244.1.0/24</code> 的 IP 包，需要经过本机 <code>eth0</code> 出去发往的下一跳ip地址为<code>10.168.0.3（node2）</code>；</p></li> <li><p>数据包到达 <code>10.168.0.3</code> 以后再通过路由表转发 <code>cni</code> 网桥，进而进入到 <code>container2</code>。</p></li></ol> <p>以上可以看到 host-gw 工作原理就是在每个 node 节点都需要配置到每个 pod 网段的下一跳为pod网段所在的 node 节点 IP，pod 网段和 node 节点 ip 的映射关系，flannel 保存在etcd中，flannel 只需要 watch 这些数据的变化来动态更新路由表即可。</p> <p><strong>优势：</strong></p> <ul><li>避免了额外的封包和解包带来的网络性能损耗；</li></ul> <p><strong>缺点：</strong></p> <ul><li>容器ip包通过下一跳出去时，必须要二层通信封装成数据帧发送到下一跳。如果不在同个二层局域网，那么就要交给三层网关，而此时网关是不知道目标容器网络的（也可以静态在每个网关配置pod网段路由）。所以 <strong><code>flannel host-gw</code> 必须要求集群宿主机是二层互通的。</strong></li></ul> <h2 id="calico插件"><a href="#calico插件" class="header-anchor">#</a> calico插件</h2> <h3 id="calico组成"><a href="#calico组成" class="header-anchor">#</a> calico组成</h3> <p>calico 主要由三个部分组成：</p> <ul><li><code>calico cni插件</code>: 主要负责与kubernetes对接，供kubelet调用使用；</li> <li><code>felix</code>: 负责维护宿主机上的路由规则、FIB转发信息库等；</li> <li><code>BIRD</code>: 负责分发路由规则，类似路由器；</li> <li><code>confd</code>: 配置管理组件；</li></ul> <h3 id="calico-bgp模式"><a href="#calico-bgp模式" class="header-anchor">#</a> calico BGP模式</h3> <p>calico BGP 大三层网络模式与flannel 提供的类似，也会在每台宿主机添加如下格式的路由规则：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span>目标容器IP网段<span class="token operator">&gt;</span> via <span class="token operator">&lt;</span>网关的IP地址<span class="token operator">&gt;</span> dev eth0
</code></pre></div><p>其中网关的 IP 地址不通场景有不同的意思：</p> <ul><li>如果宿主机是二层可达那么就是目的容器所在的宿主机的 IP 地址;</li> <li>如果是三层不同局域网那么就是本机宿主机的网关IP（交换机或者路由器地址）;</li></ul> <p>不同于 flannel 通过 etcd 存储的数据来维护本机路由信息的做法，calico是通过<strong>BGP动态路由协议</strong>来分发整个集群路由信息。</p> <blockquote><p>BGP：Border Gateway Protocol边界网关协议，linxu原生支持的、专门用于在大规模数据中心为不同的自治系统之间传递路由信息。</p></blockquote> <p><img src="/missionOne/assets/img/calico-bgp.88d98b75.png" alt="calico bgp"></p> <p>calico为每个容器设置一个 <code>veth pair</code> 设备，然后把另一端接入到宿主机网络空间，由于没有网桥，cni 插件还需要在宿主机上为每个容器的 <code>veth pair</code>设备配置一条路由规则，用于接收传入的IP包，路由规则如下：</p> <div class="language- extra-class"><pre class="language-text"><code>10.92.77.163 dev cali93a8a799fe1 scope link
</code></pre></div><blockquote><p>以上表示发送<code>10.92.77.163</code>的IP包应该发给<code>cali93a8a799fe1</code>设备，然后到达另外一段容器中。</p></blockquote> <p>这样容器发出的IP包就会通过<code>veth pair</code>设备到达宿主机，然后宿主机根据路有规则的下一条地址，发送给正确的网关<code>(10.100.1.3)</code>，然后到达目标宿主机，在到达目标容器。</p> <p>这些路由规则都是<code>felix</code>维护配置的，而路由信息则是<code>calico bird</code>组件基于<code>BGP</code>分发而来。calico实际上是将集群里所有的节点都当做边界路由器来处理,他们一起组成了一个全互联的网络，彼此之间通过BGP交换路由，这些节点我们叫做<code>BGP Peer</code>。</p> <blockquote><p>需要注意的是calico 维护网络的默认模式是 <code>node-to-node mesh</code> ,这种模式下，每台宿主机的BGP client都会跟集群所有的节点BGP client进行通信交换路由。这样一来，随着节点规模数量N的增加，连接会以N的2次方增长，会集群网络本身带来巨大压力。所以一般这种模式推荐的集群规模在50节点左右,超过50节点推荐使用另外一种<code>RR（Router Reflector）模式</code>；</p></blockquote> <h3 id="calico-ipip模式"><a href="#calico-ipip模式" class="header-anchor">#</a> calico IPIP模式</h3> <p>为了解决<code>flannel host-gw</code>二层互通的限制性，<code>calico IPIP</code>提供的网络方案就可以更好的实现；</p> <p>当我们有两台宿主机，一台是<code>10.100.0.2/24</code>，节点上容器网络是<code>10.92.204.0/24</code>;另外一台是<code>10.100.1.2/24</code>,节点上容器网络是<code>10.92.203.0/24</code>,此时两台机器因为不在同个二层所以需要三层路由通信，这时calico就会在节点上生成如下路由表：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">10.92</span>.203.0/23 via <span class="token number">10.100</span>.1.2 dev eth0 proto bird
</code></pre></div><p>这时候因为<code>10.100.1.2</code>跟我们<code>10.100.0.2</code>不在同个子网，是不能二层通信的。这之后就需要使用<code>Calico IPIP</code>模式，当宿主机不在同个二层网络时就是用overlay网络封装以后再发出去。如下图所示：</p> <p><img src="/missionOne/assets/img/calico-ipip.5e2f4649.png" alt="calico ipip"></p> <p>IPIP模式下在非二层通信时，calico 会在node节点添加如下路由规则:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">10.92</span>.203.0/24 via <span class="token number">10.100</span>.1.2 dev tunnel0
</code></pre></div><p>可以看到尽管下一跳任然是node的IP地址，但是出口设备却是<code>tunnel0</code>，其是一个IP隧道设备，主要由Linux内核的IPIP驱动实现，会将容器的ip包直接封装宿主机网络的IP包中，这样到达node2以后再经过IPIP驱动拆包拿到原始容器IP包，然后通过路由规则发送给<code>veth pair</code>设备到达目标容器。</p> <p>以上仍然会因为封包和解包导致性能下降。如果calico 能够让宿主机之间的router设备也学习到容器路由规则，这样就可以直接三层通信了。比如在路由器添加如下的路由表：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">10.92</span>.203.0/24 via <span class="token number">10.100</span>.1.2 dev interface1
</code></pre></div><p>而node1添加如下的路由表:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">10.92</span>.203.0/24 via <span class="token number">10.100</span>.1.1 dev tunnel0
</code></pre></div><p>那么node1上的容器发出的IP包，基于本地路由表发送给<code>10.100.1.1</code>网关路由器，然后路由器收到IP包查看目的IP，通过本地路由表找到下一跳地址发送到node2，最终到达目的容器。这种方案，我们是可以基于underlay 网络来实现，只要底层支持BGP网络，可以和我们RR节点建立EBGP关系来交换集群内的路由信息。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/missionOne/Kubernetes/pod优雅关闭重启.html" class="prev">
          pod优雅关闭重启
        </a></span> <span class="next"><a href="/missionOne/Kubernetes常见问题/kernel.pid_max引起的问题.html">
          kernel.pid_max引发的集群问题
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#容器网络" class="sidebar-link reco-side-容器网络" data-v-b57cc07c>容器网络</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#容器网络要素" class="sidebar-link reco-side-容器网络要素" data-v-b57cc07c>容器网络要素</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#同宿主机容器通信" class="sidebar-link reco-side-同宿主机容器通信" data-v-b57cc07c>同宿主机容器通信</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#实践" class="sidebar-link reco-side-实践" data-v-b57cc07c>实践</a></li><li class="level-2" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#cni-跨主机通信" class="sidebar-link reco-side-cni-跨主机通信" data-v-b57cc07c>CNI--跨主机通信</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#什么是cni" class="sidebar-link reco-side-什么是cni" data-v-b57cc07c>什么是CNI</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#cni网络模式实现" class="sidebar-link reco-side-cni网络模式实现" data-v-b57cc07c>CNI网络模式实现</a></li><li class="level-2" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#flannel插件" class="sidebar-link reco-side-flannel插件" data-v-b57cc07c>flannel插件</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#flannel-host-gw模式" class="sidebar-link reco-side-flannel-host-gw模式" data-v-b57cc07c>flannel host-gw模式</a></li><li class="level-2" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#calico插件" class="sidebar-link reco-side-calico插件" data-v-b57cc07c>calico插件</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#calico组成" class="sidebar-link reco-side-calico组成" data-v-b57cc07c>calico组成</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#calico-bgp模式" class="sidebar-link reco-side-calico-bgp模式" data-v-b57cc07c>calico BGP模式</a></li><li class="level-3" data-v-b57cc07c><a href="/missionOne/Kubernetes/kubernetes%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C.html#calico-ipip模式" class="sidebar-link reco-side-calico-ipip模式" data-v-b57cc07c>calico IPIP模式</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/missionOne/assets/js/app.d1f3ab04.js" defer></script><script src="/missionOne/assets/js/3.4a4ab4e6.js" defer></script><script src="/missionOne/assets/js/1.6a874a38.js" defer></script><script src="/missionOne/assets/js/8.4e05e388.js" defer></script>
  </body>
</html>
